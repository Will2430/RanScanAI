<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>RanScanAI - Change Password</title>
	<link rel="preconnect" href="https://fonts.googleapis.com"/>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
	<link rel="stylesheet" href="RSA_changepassword.css" />
</head>
<body>
	<!-- Header -->
	<header class="header">
		<div class="header-left">
			<a class="logo" href="/userdashboard_page/RSA_userdashboard.html" aria-label="Go to dashboard">
				<img src="/userdashboard_page/RSA_logo.png" alt="RanScanAI logo" class="logo-img" />
				<span class="logo-text"><span class="logo-ran">Ran</span><span class="logo-scan">Scan</span><span class="logo-ai">AI</span></span>
			</a>
			<span class="header-divider"></span>
			<span class="header-page-title">Change Password</span>
		</div>
		<div class="header-right">
			<a class="icon-btn user-btn" href="/userprofile_page/RSA_userprofile.html" aria-label="User profile">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
			</a>
		</div>
	</header>

	<main class="page-wrap">
		<div class="page-title">
			<a class="back-link" href="/userprofile_page/RSA_userprofile.html" aria-label="Back to profile">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
				<span>Back to Profile</span>
			</a>
			<h1>Change Password</h1>
		</div>

		<div class="form-container">
			<div class="form-card">
				<!-- Lock Icon -->
				<div class="form-header">
					<div class="form-icon">
						<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><circle cx="12" cy="16" r="1"/></svg>
					</div>
					<h2>Set a New Password</h2>
					<p>Your identity has been verified. Enter your new password below.</p>
				</div>

				<form id="change-pw-form" autocomplete="off">
					<!-- New Password -->
					<div class="input-group">
						<label for="new-pw">New Password</label>
						<div class="pw-input-wrap">
							<input type="password" id="new-pw" required minlength="8" placeholder="Minimum 8 characters" autocomplete="new-password" />
							<button type="button" class="pw-toggle" data-target="new-pw" aria-label="Show password">
								<svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
								<svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
							</button>
						</div>
						<!-- Strength indicator -->
						<div class="pw-strength">
							<div class="pw-strength-bar"><div class="pw-strength-fill" id="pw-strength-fill"></div></div>
							<span class="pw-strength-label" id="pw-strength-label"></span>
						</div>
					</div>

					<!-- Confirm Password -->
					<div class="input-group">
						<label for="confirm-pw">Confirm New Password</label>
						<div class="pw-input-wrap">
							<input type="password" id="confirm-pw" required minlength="8" placeholder="Re-enter new password" autocomplete="new-password" />
							<button type="button" class="pw-toggle" data-target="confirm-pw" aria-label="Show password">
								<svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
								<svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
							</button>
						</div>
						<div class="pw-match" id="pw-match-msg"></div>
					</div>

					<!-- Password Requirements -->
					<div class="pw-requirements">
						<div class="req-item" id="req-length"><span class="req-icon">○</span> At least 8 characters</div>
						<div class="req-item" id="req-upper"><span class="req-icon">○</span> One uppercase letter</div>
						<div class="req-item" id="req-lower"><span class="req-icon">○</span> One lowercase letter</div>
						<div class="req-item" id="req-number"><span class="req-icon">○</span> One number</div>
					</div>

					<!-- Error / Success -->
					<div class="form-message error" id="form-error"></div>
					<div class="form-message success" id="form-success"></div>

					<!-- Submit -->
					<button type="submit" class="submit-btn" id="submit-btn" disabled>
						<span class="btn-text">Update Password</span>
						<span class="btn-spinner" style="display:none"></span>
					</button>
				</form>
			</div>
		</div>
	</main>

	<script>
	// ============================================================
	// Change Password Page
	// ============================================================
	const API_BASE = 'http://127.0.0.1:8000';

	// Guard: must have verified identity from profile page
	(() => {
		const verified = sessionStorage.getItem('pw_verified');
		const ts = parseInt(sessionStorage.getItem('pw_verified_ts') || '0', 10);
		const FIVE_MIN = 5 * 60 * 1000;
		if (verified !== 'true' || (Date.now() - ts) > FIVE_MIN) {
			// Not verified or expired → redirect back to profile
			sessionStorage.removeItem('pw_verified');
			sessionStorage.removeItem('pw_verified_ts');
			window.location.href = '/userprofile_page/RSA_userprofile.html';
			return;
		}
	})();

	const newPwInput = document.getElementById('new-pw');
	const confirmPwInput = document.getElementById('confirm-pw');
	const strengthFill = document.getElementById('pw-strength-fill');
	const strengthLabel = document.getElementById('pw-strength-label');
	const matchMsg = document.getElementById('pw-match-msg');
	const formError = document.getElementById('form-error');
	const formSuccess = document.getElementById('form-success');
	const submitBtn = document.getElementById('submit-btn');
	const form = document.getElementById('change-pw-form');

	// Requirements checkers
	const reqs = {
		length: { el: document.getElementById('req-length'), test: (v) => v.length >= 8 },
		upper:  { el: document.getElementById('req-upper'),  test: (v) => /[A-Z]/.test(v) },
		lower:  { el: document.getElementById('req-lower'),  test: (v) => /[a-z]/.test(v) },
		number: { el: document.getElementById('req-number'), test: (v) => /\d/.test(v) },
	};

	function checkRequirements(pw) {
		let passed = 0;
		for (const [key, req] of Object.entries(reqs)) {
			const ok = req.test(pw);
			req.el.classList.toggle('met', ok);
			req.el.querySelector('.req-icon').textContent = ok ? '●' : '○';
			if (ok) passed++;
		}
		return passed;
	}

	function updateStrength(pw) {
		if (!pw) {
			strengthFill.style.width = '0';
			strengthLabel.textContent = '';
			return 0;
		}
		let score = 0;
		if (pw.length >= 8) score++;
		if (pw.length >= 12) score++;
		if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
		if (/\d/.test(pw)) score++;
		if (/[^A-Za-z0-9]/.test(pw)) score++;

		const levels = [
			{ max: 1, label: 'Weak',   color: '#ef4444', width: '20%' },
			{ max: 2, label: 'Fair',   color: '#f59e0b', width: '40%' },
			{ max: 3, label: 'Good',   color: '#3b82f6', width: '65%' },
			{ max: 4, label: 'Strong', color: '#22c55e', width: '85%' },
			{ max: 5, label: 'Excellent', color: '#16a34a', width: '100%' },
		];
		const level = levels[Math.min(score, levels.length) - 1] || levels[0];
		strengthFill.style.width = level.width;
		strengthFill.style.background = level.color;
		strengthLabel.textContent = level.label;
		strengthLabel.style.color = level.color;
		return score;
	}

	function checkMatch() {
		const newPw = newPwInput.value;
		const confirmPw = confirmPwInput.value;
		if (!confirmPw) {
			matchMsg.textContent = '';
			matchMsg.className = 'pw-match';
			return false;
		}
		if (newPw === confirmPw) {
			matchMsg.textContent = '✓ Passwords match';
			matchMsg.className = 'pw-match match-ok';
			return true;
		}
		matchMsg.textContent = '✗ Passwords do not match';
		matchMsg.className = 'pw-match match-fail';
		return false;
	}

	function validateForm() {
		const pw = newPwInput.value;
		const allReqsMet = Object.values(reqs).every(r => r.test(pw));
		const matching = newPwInput.value && newPwInput.value === confirmPwInput.value;
		submitBtn.disabled = !(allReqsMet && matching);
	}

	newPwInput.addEventListener('input', () => {
		checkRequirements(newPwInput.value);
		updateStrength(newPwInput.value);
		checkMatch();
		validateForm();
	});

	confirmPwInput.addEventListener('input', () => {
		checkMatch();
		validateForm();
	});

	// Toggle password visibility
	document.querySelectorAll('.pw-toggle').forEach(btn => {
		btn.addEventListener('click', () => {
			const input = document.getElementById(btn.dataset.target);
			const isHidden = input.type === 'password';
			input.type = isHidden ? 'text' : 'password';
			btn.querySelector('.eye-open').style.display = isHidden ? 'none' : '';
			btn.querySelector('.eye-closed').style.display = isHidden ? '' : 'none';
		});
	});

	// Submit
	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		const newPw = newPwInput.value;
		const confirmPw = confirmPwInput.value;

		formError.style.display = 'none';
		formSuccess.style.display = 'none';

		if (newPw !== confirmPw) {
			formError.textContent = 'Passwords do not match.';
			formError.style.display = 'block';
			return;
		}

		const token = localStorage.getItem('access_token');
		if (!token) { window.location.href = '/login'; return; }

		// We need the old password — retrieve from the login session
		// Re-prompt isn't needed since we verified in the modal, but the API requires it.
		// We'll get the user to provide it again if the session expired, but ideally
		// we store it temporarily in sessionStorage from the profile page
		const userData = JSON.parse(localStorage.getItem('user_data') || '{}');

		// Show loading
		submitBtn.querySelector('.btn-text').style.display = 'none';
		submitBtn.querySelector('.btn-spinner').style.display = '';
		submitBtn.disabled = true;

		try {
			// We need old_password for the API. Since we verified it on the profile page,
			// we pass it from sessionStorage (set during verification).
			const oldPw = sessionStorage.getItem('pw_old_value') || '';

			const res = await fetch(`${API_BASE}/api/auth/change-password`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': 'Bearer ' + token
				},
				body: JSON.stringify({
					old_password: oldPw,
					new_password: newPw
				})
			});

			const data = await res.json();

			if (res.ok) {
				formSuccess.textContent = 'Password updated successfully! Redirecting...';
				formSuccess.style.display = 'block';
				form.reset();
				strengthFill.style.width = '0';
				strengthLabel.textContent = '';
				matchMsg.textContent = '';
				document.querySelectorAll('.req-item').forEach(el => {
					el.classList.remove('met');
					el.querySelector('.req-icon').textContent = '○';
				});

				// Clean up verification
				sessionStorage.removeItem('pw_verified');
				sessionStorage.removeItem('pw_verified_ts');
				sessionStorage.removeItem('pw_old_value');

				setTimeout(() => {
					window.location.href = '/userprofile_page/RSA_userprofile.html';
				}, 2000);
			} else {
				formError.textContent = data.detail || 'Failed to change password.';
				formError.style.display = 'block';
			}
		} catch (err) {
			formError.textContent = 'Connection error. Please try again.';
			formError.style.display = 'block';
		} finally {
			submitBtn.querySelector('.btn-text').style.display = '';
			submitBtn.querySelector('.btn-spinner').style.display = 'none';
			submitBtn.disabled = false;
			validateForm();
		}
	});
	</script>
</body>
</html>
