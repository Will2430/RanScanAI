<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>RanScanAI - Detection Details</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
	<link rel="stylesheet" href="RSA_viewlatestdetectiondetails.css" />
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a class="logo" href="../userdashboard_page/RSA_userdashboard.html" aria-label="Go to dashboard">
                <img src="../userdashboard_page/RSA_logo.png" alt="RanScanAI logo" class="logo-img" />
                <span class="logo-text"><span class="logo-ran">Ran</span><span class="logo-scan">Scan</span><span class="logo-ai">AI</span></span>
            </a>
            <span class="header-divider"></span>
            <span class="header-page-title">Incident Details</span>
        </div>
        <div class="header-right">
            <button class="icon-btn bell-btn" aria-label="Notifications">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                <span class="notif-dot"></span>
            </button>
            <a class="icon-btn user-btn" href="../userprofile_page/RSA_userprofile.html" aria-label="User profile">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </a>
        </div>
    </header>

	<main class="page-wrap">
        <div class="page-title">
            <a class="back-link" href="../userdashboard_page/RSA_userdashboard.html" aria-label="Back to dashboard">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                <span>Back to Dashboard</span>
            </a>
            <h1>Incident Details</h1>
		</div>

        <!-- Loading state -->
        <div id="loading-state" class="details-grid" style="display:none;">
            <section class="details-card summary-card">
                <div class="card-header"><h2>Loading...</h2></div>
                <div class="summary-content">
                    <p style="color:#5B6380;">Fetching latest detection data...</p>
                </div>
            </section>
        </div>

        <!-- Error state -->
        <div id="error-state" class="details-grid" style="display:none;">
            <section class="details-card summary-card">
                <div class="card-header"><h2>No Detection Found</h2></div>
                <div class="summary-content">
                    <div class="summary-icon" style="background:var(--bg-hover);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#5B6380" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    </div>
                    <div class="summary-info">
                        <h3 class="threat-name" id="error-message">No detections available</h3>
                        <p class="threat-type">Scan a file to see detection details here.</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Detection details (populated dynamically) -->
        <div id="detection-content" class="details-grid" style="display:none;">
            <!-- Summary Card -->
            <section class="details-card summary-card">
                <div class="card-header">
                    <h2>Threat Summary</h2>
                    <span class="severity-badge" id="severity-badge">—</span>
                </div>
                <div class="summary-content">
                    <div class="summary-icon" id="summary-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    </div>
                    <div class="summary-info">
                        <h3 class="threat-name" id="threat-name">—</h3>
                        <p class="threat-type" id="threat-type">—</p>
                    </div>
                </div>
            </section>

            <!-- Info Card -->
            <section class="details-card info-card">
                <h2>Detection Information</h2>
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label">Detection ID</span>
                        <span class="info-value" id="detection-id">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Date</span>
                        <span class="info-value" id="detection-date">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Time</span>
                        <span class="info-value" id="detection-time">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Model</span>
                        <span class="info-value" id="detection-model">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Features Analyzed</span>
                        <span class="info-value" id="detection-features">—</span>
                    </div>
                </div>
            </section>

            <!-- File Details Card -->
            <section class="details-card file-card">
                <h2>File Details</h2>
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label">File Path</span>
                        <span class="info-value file-path" id="file-path">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">File Size</span>
                        <span class="info-value" id="file-size">—</span>
                    </div>
                    <div class="info-row" id="hash-row">
                        <span class="info-label">SHA-256</span>
                        <span class="info-value hash-value" id="file-hash">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" id="detection-status">—</span>
                    </div>
                </div>
            </section>
            
            <!-- Action Card -->
            <section class="details-card action-card">
                <h2>Recommended Actions</h2>
                <p class="action-desc" id="action-desc">—</p>
                <div class="action-buttons" id="action-buttons">
                    <button class="btn btn-danger">Delete File</button>
                    <button class="btn btn-secondary">Restore (Not Recommended)</button>
                </div>
            </section>
        </div>
	</main>

    <script>
    // ============================================================
    // Fetch & render the latest detection for the logged-in user
    // ============================================================
    (function () {
        const API_BASE = 'http://127.0.0.1:8000';

        function authHeaders() {
            const token = localStorage.getItem('access_token');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }

        // Redirect to login if not authenticated
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
            return;
        }

        const loadingEl  = document.getElementById('loading-state');
        const errorEl    = document.getElementById('error-state');
        const contentEl  = document.getElementById('detection-content');

        // Show loading
        loadingEl.style.display = '';

        // Check if a specific detection ID was passed via URL query param
        const urlParams = new URLSearchParams(window.location.search);
        const detectionId = urlParams.get('id');

        async function fetchDetection() {
            try {
                let data;

                if (detectionId) {
                    // Fetch specific detection by ID
                    const res = await fetch(`${API_BASE}/api/detections/${detectionId}`, { headers: authHeaders() });
                    if (!res.ok) {
                        if (res.status === 401) { clearAuthAndRedirect(); return; }
                        throw new Error(res.status === 404 ? 'Detection not found' : 'Failed to fetch detection');
                    }
                    data = await res.json();
                } else {
                    // Try the /user/latest endpoint first
                    let res = await fetch(`${API_BASE}/api/detections/user/latest`, { headers: authHeaders() });
                    
                    if (res.status === 404 || res.status === 405) {
                        // Fallback: fetch latest via list endpoint
                        res = await fetch(`${API_BASE}/api/detections?limit=1`, { headers: authHeaders() });
                        if (!res.ok) {
                            if (res.status === 401) { clearAuthAndRedirect(); return; }
                            throw new Error('Failed to fetch detections');
                        }
                        const listData = await res.json();
                        if (!listData.detections || listData.detections.length === 0) {
                            throw new Error('No detections found');
                        }
                        const latestId = listData.detections[0].id;
                        // Get full details for this detection
                        const detailRes = await fetch(`${API_BASE}/api/detections/${latestId}`, { headers: authHeaders() });
                        if (!detailRes.ok) throw new Error('Failed to fetch detection details');
                        data = await detailRes.json();
                    } else if (!res.ok) {
                        if (res.status === 401) { clearAuthAndRedirect(); return; }
                        throw new Error('Failed to fetch latest detection');
                    } else {
                        data = await res.json();
                    }
                }

                loadingEl.style.display = 'none';
                renderDetection(data);
                contentEl.style.display = '';
            } catch (err) {
                loadingEl.style.display = 'none';
                document.getElementById('error-message').textContent = err.message || 'No detections available';
                errorEl.style.display = '';
            }
        }

        function clearAuthAndRedirect() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_data');
            window.location.href = '/login';
        }

        fetchDetection();

        function renderDetection(d) {
            // --- Severity ---
            const confidence = d.confidence || 0;
            let severityText, severityClass;
            if (!d.is_malicious) {
                severityText = 'SAFE';
                severityClass = 'severity-safe';
            } else if (confidence >= 0.9) {
                severityText = 'CRITICAL';
                severityClass = 'severity-critical';
            } else if (confidence >= 0.7) {
                severityText = 'HIGH';
                severityClass = 'severity-high';
            } else {
                severityText = 'MEDIUM';
                severityClass = 'severity-medium';
            }

            const badge = document.getElementById('severity-badge');
            badge.textContent = severityText;
            badge.className = 'severity-badge ' + severityClass;

            // --- Threat name & type ---
            document.getElementById('threat-name').textContent = d.file_name || '—';
            const threatType = d.is_malicious
                ? (d.prediction_label === 'MALWARE' ? 'Malware Detected' : d.prediction_label)
                : 'No Threat Detected';
            document.getElementById('threat-type').textContent = threatType + ' (' + (confidence * 100).toFixed(1) + '% confidence)';

            // --- Summary icon colour ---
            const iconWrap = document.getElementById('summary-icon');
            if (d.is_malicious) {
                iconWrap.style.background = 'var(--color-danger-bg)';
                iconWrap.querySelector('svg').style.stroke = 'var(--color-danger)';
            } else {
                iconWrap.style.background = 'var(--color-success-bg)';
                iconWrap.querySelector('svg').innerHTML = '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>';
                iconWrap.querySelector('svg').style.stroke = 'var(--color-success)';
            }

            // --- Detection info ---
            document.getElementById('detection-id').textContent = 'D' + String(d.id).padStart(3, '0');

            // Parse date/time from display_time or timestamp
            if (d.display_time) {
                const parts = d.display_time.split(' ');
                // display_time format: "22 February 2026 18:24:05"
                if (parts.length >= 4) {
                    document.getElementById('detection-date').textContent = parts[0] + ' ' + parts[1] + ' ' + parts[2];
                    document.getElementById('detection-time').textContent = parts[3];
                } else {
                    document.getElementById('detection-date').textContent = d.display_time;
                }
            } else if (d.timestamp) {
                const dt = new Date(d.timestamp);
                document.getElementById('detection-date').textContent = dt.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('detection-time').textContent = dt.toLocaleTimeString('en-GB');
            }

            document.getElementById('detection-model').textContent = d.model_type || '—';
            document.getElementById('detection-features').textContent = d.features_analyzed != null ? d.features_analyzed.toLocaleString() : '—';

            // Status
            const statusEl = document.getElementById('detection-status');
            if (d.is_malicious) {
                statusEl.textContent = 'Quarantined';
                statusEl.className = 'info-value status-quarantined';
            } else {
                statusEl.textContent = 'Clean';
                statusEl.className = 'info-value status-clean';
            }

            // --- File details ---
            document.getElementById('file-path').textContent = d.file_path || '—';
            document.getElementById('file-size').textContent = d.file_size ? formatFileSize(d.file_size) : '—';
            // Only show SHA-256 for malicious files
            const hashRow = document.getElementById('hash-row');
            if (d.is_malicious && d.file_hash) {
                document.getElementById('file-hash').textContent = d.file_hash;
                hashRow.style.display = '';
            } else {
                hashRow.style.display = 'none';
            }

            // --- Action card ---
            const actionDesc = document.getElementById('action-desc');
            const actionBtns = document.getElementById('action-buttons');
            if (d.is_malicious) {
                actionDesc.textContent = 'The threat has been isolated. Please review the file details and choose an action.';
                actionBtns.style.display = '';
            } else {
                actionDesc.textContent = 'This file has been scanned and no threats were detected. No action is required.';
                actionBtns.style.display = 'none';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
        }
    })();
    </script>
</body>
</html>
