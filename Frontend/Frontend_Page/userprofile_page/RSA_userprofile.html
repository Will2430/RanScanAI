<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>RanScanAI - User Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
	<link rel="stylesheet" href="RSA_userprofile.css" />
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
			<a class="logo" href="/userdashboard_page/RSA_userdashboard.html" aria-label="Go to dashboard">
                <img src="/userdashboard_page/RSA_logo.png" alt="RanScanAI logo" class="logo-img" />
                <span class="logo-text"><span class="logo-ran">Ran</span><span class="logo-scan">Scan</span><span class="logo-ai">AI</span></span>
			</a>
            <span class="header-divider"></span>
			<span class="header-page-title">Profile Overview</span>
        </div>
        <div class="header-right">
            <button class="icon-btn bell-btn" aria-label="Notifications">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                <span class="notif-dot"></span>
            </button>
            <a class="icon-btn user-btn" href="#" aria-label="User profile">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </a>
        </div>
    </header>

	<main class="page-wrap">
		<div class="page-title">
			<a class="back-link" href="/userdashboard_page/RSA_userdashboard.html" aria-label="Back to dashboard">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                <span>Back to Dashboard</span>
            </a>
			<h1>Profile Overview</h1>
		</div>
		<div class="profile-grid">
			<section class="profile-card panel-left">
				<div class="profile-summary">
					<img src="RSA_profile.png" alt="User profile" class="profile-avatar" />
					<div class="profile-name" id="profile-display-name">User Name</div>
					<div class="profile-role" id="profile-display-role">USER</div>
					<div class="profile-info-list">
						<div class="profile-info-card">
							<div class="info-label">User Name</div>
							<div class="info-value" id="profile-username">UserName001</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">Password</div>
							<div class="info-value">********</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">User ID</div>
							<div class="info-value" id="profile-user-id">—</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">Account Status</div>
							<div class="info-value" id="profile-status">Active</div>
						</div>
					</div>
				</div>
			</section>
			<div class="panel-right">
				<section class="profile-card subscription-card">
					<div class="subscription-row">
						<span class="subscription-label">Account Created</span>
						<span class="subscription-badge" id="profile-created-at">—</span>
					</div>
					<div class="subscription-validity">
						<span class="subscription-valid-label">Last Login:</span>
						<span class="subscription-valid-date" id="profile-last-login">—</span>
					</div>
				</section>
				<section class="profile-card personal-info-card">
					<h2>Personal Information</h2>
					<div class="personal-info-list">
						<div class="profile-info-card">
							<div class="info-label">First Name</div>
							<div class="info-value" id="profile-first-name">UserFN</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">Last Name</div>
							<div class="info-value" id="profile-last-name">UserLN</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">Email Address</div>
							<div class="info-value" id="profile-email">useremail@gmail.com</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">Phone Number</div>
							<div class="info-value" id="profile-phone">
								<span class="phone-number">—</span>
							</div>
						</div>
						<div class="profile-info-card">
							<div class="info-label">Role</div>
							<div class="info-value" id="profile-role">user</div>
						</div>
					</div>
				</section>
			</div>
		</div>
	</main>

	<script>
	// ============================================================
	// Profile Page — Populate from localStorage + fetch fresh data
	// ============================================================
	const API_BASE = 'http://127.0.0.1:8000';

	function populateProfile(user) {
		if (!user) return;

		// Left panel
		const displayName = document.getElementById('profile-display-name');
		const displayRole = document.getElementById('profile-display-role');
		const usernameEl  = document.getElementById('profile-username');
		const userIdEl    = document.getElementById('profile-user-id');
		const statusEl    = document.getElementById('profile-status');

		if (displayName) displayName.textContent = (user.first_name || '') + ' ' + (user.last_name || '');
		if (displayRole) displayRole.textContent = (user.role || 'user').toUpperCase();
		if (usernameEl)  usernameEl.textContent  = user.username || '—';
		if (userIdEl)    userIdEl.textContent     = user.user_id || '—';
		if (statusEl)    statusEl.textContent     = user.is_active ? '● Active' : '○ Inactive';

		// Right panel — account info
		const createdEl  = document.getElementById('profile-created-at');
		const lastLogin  = document.getElementById('profile-last-login');
		if (createdEl && user.created_at) {
			createdEl.textContent = new Date(user.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
		}
		if (lastLogin && user.last_login) {
			lastLogin.textContent = new Date(user.last_login).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
		} else if (lastLogin) {
			lastLogin.textContent = 'First login';
		}

		// Personal information
		const firstNameEl = document.getElementById('profile-first-name');
		const lastNameEl  = document.getElementById('profile-last-name');
		const emailEl     = document.getElementById('profile-email');
		const phoneEl     = document.getElementById('profile-phone');
		const roleEl      = document.getElementById('profile-role');

		if (firstNameEl) firstNameEl.textContent = user.first_name || '—';
		if (lastNameEl)  lastNameEl.textContent  = user.last_name || '—';
		if (emailEl)     emailEl.textContent      = user.email || '—';
		if (phoneEl)     phoneEl.textContent      = user.phone_number || '—';
		if (roleEl)      roleEl.textContent       = user.role || '—';
	}

	document.addEventListener('DOMContentLoaded', async () => {
		// 1. Instant display from localStorage
		try {
			const cached = localStorage.getItem('user_data');
			if (cached) populateProfile(JSON.parse(cached));
		} catch (e) { /* ignore parse errors */ }

		// 2. Fetch fresh data from GET /api/auth/me
		const token = localStorage.getItem('access_token');
		if (!token) return; // not logged in

		try {
			const res = await fetch(`${API_BASE}/api/auth/me`, {
				headers: { 'Authorization': 'Bearer ' + token }
			});
			if (res.ok) {
				const freshUser = await res.json();
				// Update localStorage with fresh data
				localStorage.setItem('user_data', JSON.stringify(freshUser));
				populateProfile(freshUser);
			} else if (res.status === 401) {
				// Token expired — redirect to login
				localStorage.removeItem('access_token');
				localStorage.removeItem('user_data');
				window.location.href = '/login';
			}
		} catch (err) {
			console.warn('Could not fetch fresh profile:', err);
		}
	});
	</script>
</body>
</html>
