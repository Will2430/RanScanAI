# Azure Malware Analysis Sandbox - Complete Setup Guide

## Overview
This guide walks you through setting up a safe, isolated Azure VM environment for analyzing ransomware/malware without risk to your systems or Azure account.

---

## üéØ Azure Portal Workflow (Step-by-Step)

### Phase 0: Check Allowed Regions (DO THIS FIRST!)

Azure for Students has region restrictions. Before creating anything, find your allowed regions:

**Option A - Azure Portal:**
1. Go to **Subscriptions** ‚Üí Select "Azure for Students"
2. Click **Resource providers** ‚Üí Search for "Microsoft.Compute"
3. Or try creating a test resource and see which regions are available in the dropdown

**Option B - Azure CLI (Fastest):**
```powershell
# Login first
az login

# Check allowed regions for Virtual Machines
az vm list-skus --location eastus --size Standard_B --output table
az vm list-skus --location westus --size Standard_B --output table
az vm list-skus --location centralus --size Standard_B --output table

# If you get results, that region is allowed!
# Common allowed regions for Students: East US, West US, Central US, West Europe
```

**Common Allowed Regions:**
- East US
- West US  
- Central US
- West Europe
- Southeast Asia

**Once you find an allowed region, use THAT SAME REGION for ALL resources below!**

---

### Phase 1: Create Isolated Network Infrastructure

#### Step 1: Create a Resource Group
1. **Azure Portal** ‚Üí Search "Resource Groups" ‚Üí Click **Create**
2. **Settings:**
   - Subscription: Azure for Students
   - Resource group name: `rg-malware-sandbox`
   - Region: **USE AN ALLOWED REGION FROM PHASE 0** (e.g., East US, West US, Central US)
3. Click **Review + Create** ‚Üí **Create**

**WHY:** This keeps all malware-related resources isolated and easy to delete entirely when done.

---

#### Step 2: Create Virtual Network (VNet)
1. **Azure Portal** ‚Üí Search "Virtual Networks" ‚Üí Click **Create**
2. **Basics:**
   - Resource group: `rg-malware-sandbox`
   - Name: `vnet-malware-isolated`
   - Region: Same as resource group
   
3. **IP Addresses Tab:**
   - IPv4 address space: `10.0.0.0/16`
   - Add a subnet:
     - Name: `subnet-sandbox`
     - Address range: `10.0.1.0/24`
   
4. **Security Tab:**
   - Leave defaults for now

5. Click **Review + Create** ‚Üí **Create**

**WHY:** This creates an isolated network that we'll lock down to prevent malware from spreading.

---

#### Step 3: Create Network Security Group (NSG) - CRITICAL
1. **Azure Portal** ‚Üí Search "Network Security Groups" ‚Üí **Create**
2. **Settings:**
   - Resource group: `rg-malware-sandbox`
   - Name: `nsg-sandbox-lockdown`
   - Region: Same as above

3. After creation, click on the NSG ‚Üí **Outbound security rules**
4. **DELETE ALL DEFAULT RULES** or set priority lower
5. **Add DENY RULE:**
   - Priority: `100`
   - Name: `DenyAllOutbound`
   - Source: `Any`
   - Destination: `Any`
   - Service: `Custom`
   - Destination port ranges: `*`
   - Protocol: `Any`
   - Action: **Deny**

6. Go to **Subnets** ‚Üí **Associate**
   - Virtual network: `vnet-malware-isolated`
   - Subnet: `subnet-sandbox`

**WHY:** This is your kill switch - blocks ALL outbound internet traffic so malware can't spread, encrypt cloud data, or communicate with C2 servers.

---

### Phase 2: Create the Malware Analysis VM

#### Step 4: Create Virtual Machine
1. **Azure Portal** ‚Üí Search "Virtual Machines" ‚Üí **Create** ‚Üí **Azure Virtual Machine**

2. **Basics Tab:**
   - Resource group: `rg-malware-sandbox`
   - VM name: `vm-malware-lab-01`
   - Region: Same as above
   - **Availability options:** No infrastructure redundancy required
   - **Security type:** Standard (not Trusted Launch - can interfere with monitoring tools)
   - **Image:** Windows 10 Pro (Gen 2) or Windows 11
   - **Size:** 
     - For student budget: `B2s` (2 vCPUs, 4 GB RAM) - ~$30/month
     - Better performance: `D2s_v3` (2 vCPUs, 8 GB RAM)
   - **Administrator account:**
     - Username: `labadmin` (NOT your personal name)
     - Password: Strong unique password (STORE IT SAFELY)

3. **Disks Tab:**
   - OS disk type: `Standard SSD` (cheaper, sufficient for malware analysis)
   - Delete with VM: **Yes**
   - Add data disk: (Optional) Add 32GB Standard SSD for malware samples storage

4. **Networking Tab:**
   - Virtual network: `vnet-malware-isolated`
   - Subnet: `subnet-sandbox`
   - Public IP: **Create new** (you need this for Bastion access)
   - NIC network security group: `None` (we're using subnet-level NSG)
   - **Delete public IP and NIC when VM is deleted:** Yes

5. **Management Tab:**
   - **Enable auto-shutdown:** YES
     - Time: 11:00 PM (your timezone)
     - Notification: Add your email
   - **Boot diagnostics:** Enable with managed storage account
   - **Identity:** Enable system-assigned managed identity (for future automation)

6. **Advanced Tab:**
   - Leave defaults

7. **Review + Create** ‚Üí Wait for validation ‚Üí **Create**

**COST SAVING:** Auto-shutdown prevents runaway costs if you forget to stop the VM!

---

### Phase 3: Secure Access Setup (Azure Bastion)

#### Step 5: Set Up Azure Bastion (Optional but Recommended)
Azure Bastion provides secure RDP access without exposing the VM to the internet.

1. **Azure Portal** ‚Üí Search "Bastions" ‚Üí **Create**
2. **Settings:**
   - Resource group: `rg-malware-sandbox`
   - Name: `bastion-sandbox`
   - Region: Same as above
   - Tier: `Basic` ($0.19/hour only when VM is running)
   - Virtual network: `vnet-malware-isolated`
   - Subnet: Will auto-create `AzureBastionSubnet`

3. **Review + Create** ‚Üí **Create** (takes ~10 minutes)

**ALTERNATIVE (Cheaper):** Use the public IP with RDP port 3389, but add an inbound NSG rule to allow ONLY your home IP address.

---

### Phase 4: Snapshot & Backup Strategy

#### Step 6: Create Clean Baseline Snapshot
**DO THIS BEFORE INSTALLING ANYTHING:**

1. Go to your VM ‚Üí **Stop** the VM (deallocate)
2. Go to VM ‚Üí **Disks** ‚Üí Click on the OS disk name
3. Click **Create snapshot**
   - Name: `snap-clean-baseline`
   - Resource group: `rg-malware-sandbox`
   - Snapshot type: `Full`
   - Storage type: `Standard HDD` (cheapest)
4. Click **Review + Create** ‚Üí **Create**

**CRITICAL:** You'll restore to this after every malware run!

---

#### Step 7: Install Monitoring Tools (Then Create Another Snapshot)

**Choose ONE of these approaches:**

##### **Option A: Manual Analysis Tools (Lightweight)**
Start your VM and install:
- **Sysinternals Suite** (Process Monitor, Process Explorer, Autoruns)
- **Wireshark** for network capture
- **API Monitor** for API call tracking
- **RegShot** for registry comparison
- Your Python behavioral monitoring scripts from the project

**Pros:** Lightweight, cheap, full control  
**Cons:** Manual analysis, slower workflow

##### **Option B: FLARE-VM (Recommended for Students)**
Mandiant's FLARE-VM is a pre-configured Windows malware analysis environment:

```powershell
# Inside your Azure VM, run as Administrator:
Set-ExecutionPolicy Unrestricted -Force

# Install Chocolatey first
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# Install FLARE-VM (this takes 2-3 hours!)
cd C:\
git clone https://github.com/mandiant/flare-vm.git
cd flare-vm
.\install.ps1
```

**What you get:**
- 150+ malware analysis tools pre-installed
- Debuggers (x64dbg, WinDbg, IDA Free)
- Disassemblers (Ghidra, Binary Ninja)
- Sysinternals Suite, Wireshark, API Monitor
- Python with malware analysis libraries

**Pros:** Everything pre-configured, industry standard  
**Cons:** Takes 2-3 hours to install, requires 60GB+ disk space  
**VM Requirements:** Minimum D2s_v3 (2 vCPUs, 8GB RAM), 128GB SSD

##### **Option C: CAPE Sandbox (Automated Analysis)**
CAPE v2 provides automated malware analysis with behavioral reports:

```bash
# CAPE requires Linux - deploy Ubuntu 20.04/22.04 VM instead of Windows
# Minimum: D4s_v3 (4 vCPUs, 16GB RAM), 250GB disk

# SSH into your Ubuntu Azure VM:
sudo apt update && sudo apt upgrade -y

# Install CAPE dependencies
sudo apt install -y python3 python3-pip python3-dev libffi-dev libssl-dev
sudo apt install -y postgresql mongodb-org libguac-client-rdp0 libguac-client-vnc0

# Clone CAPE
cd /opt
sudo git clone https://github.com/kevoreilly/CAPEv2.git
cd CAPEv2

# Run installer (follow prompts)
sudo ./extras/install.sh

# Configure CAPE to use your isolated network
sudo nano /opt/CAPEv2/conf/cuckoo.conf
# Set: machinery = az (for Azure VMs)
# Configure network interface to your isolated VNet

# Start CAPE
sudo supervisorctl start cape
```

**What you get:**
- Automated malware submission via web interface
- Behavioral analysis reports (JSON, HTML)
- API call traces, network traffic capture
- Memory dumps and process trees
- Yara rule matching
- RESTful API for backend integration

**Pros:** Fully automated, generates structured reports, REST API  
**Cons:** Expensive (~$100-150/month), complex setup, requires Linux  
**VM Requirements:** D4s_v3 or larger (4 vCPUs, 16GB RAM minimum)

---

**RECOMMENDED APPROACH FOR YOUR PROJECT:**

1. **Start with FLARE-VM** (one-time setup, snapshot it)
2. **Use your own Python scripts** to extract behavioral features
3. **Pipe results to your ransomware detection backend**

This gives you automated monitoring WITHOUT the $100+/month cost of running CAPE 24/7.

---

Then create snapshots:
- Name: `snap-ready-for-analysis` (after tool installation)
- Name: `snap-flare-configured` (if using FLARE-VM)

**Snapshot Cost:** ~$0.05/GB/month (very cheap!)

---

## üîí Security Verification Checklist

Before running ANY malware, verify:

- [ ] NSG has `DenyAllOutbound` rule at priority 100
- [ ] VM is in isolated VNet with no peering connections
- [ ] VM has NO access to Azure AD, Azure Storage, or other Azure services
- [ ] Auto-shutdown is configured
- [ ] Clean baseline snapshot exists
- [ ] Different credentials than your main Azure account
- [ ] No personal files or data on the VM

---

## üîÑ Malware Analysis Workflow

### Workflow Steps:
```
1. Restore VM from "snap-ready-for-analysis" snapshot
   ‚îî‚îÄ Disk ‚Üí Snapshots ‚Üí Create disk from snapshot ‚Üí Swap OS disks

2. Start VM and connect via Bastion (or RDP from your IP only)

3. Start monitoring tools:
   - Process Monitor (filter on file, registry, network)
   - Wireshark
   - Your behavioral logger

4. Transfer malware sample:
   - Upload via Bastion file transfer
   - OR use isolated Azure Blob Storage in same resource group
   - NEVER use email, OneDrive, or connected services

5. Execute malware in monitored environment

6. Collect logs and behavioral data
   - Export to external storage immediately
   - Don't leave sensitive data on VM

7. Stop VM (deallocate)

8. Restore from snapshot for next run
   ‚îî‚îÄ OR delete disk and recreate from snapshot
```

---

## üí∞ Cost Management for Azure Students

### Sandbox Solution Comparison

| Solution | VM Size | Monthly Cost* | Pros | Cons | Best For |
|----------|---------|---------------|------|------|----------|
| **Manual Tools** | B2s (2 vCPU, 4GB) | ~$15 | Cheapest, full control | Manual analysis, slower | Tight budgets, learning |
| **FLARE-VM** | D2s_v3 (2 vCPU, 8GB) | ~$40 | Pre-configured, industry standard | One-time 3hr install | Student projects, presentations |
| **CAPE v2** | D4s_v3 (4 vCPU, 16GB) | ~$120 | Fully automated, REST API | Expensive, complex setup | Production environments, automation |
| **Hybrid** | B2s + FLARE | ~$25 | Best value, automated scripts | Some manual work | **Recommended for your project** |

*Assumes 8 hours/day usage with auto-shutdown. Add +$5-10 for storage, +$46 for Bastion (skip it!)

### Typical Monthly Costs:
- **VM B2s (8 hours/day usage):** ~$10
- **VM D2s_v3 (8 hours/day, FLARE-VM):** ~$35
- **VM D4s_v3 (8 hours/day, CAPE):** ~$110
- **Storage (OS disk + snapshots):** ~$5
- **Bastion (8 hours/day):** ~$46 (expensive!)
- **Networking:** ~$1

### Cost Optimization Strategies:

1. **Stop (deallocate) VM when not analyzing:**
   ```powershell
   # Stop VM (no compute charges)
   az vm deallocate --resource-group rg-malware-sandbox --name vm-malware-lab-01
   
   # Start VM
   az vm start --resource-group rg-malware-sandbox --name vm-malware-lab-01
   ```

2. **Skip Bastion, use IP whitelisting instead:**
   - Create NSG inbound rule allowing RDP (3389) from YOUR IP only
   - Saves $46/month!

3. **Delete old snapshots:**
   - Keep only 2-3 most recent snapshots
   - Delete old ones: ~$0.05/GB saved per month

4. **Use B-series burstable VMs:**
   - Cheapest option for intermittent workloads
   - Perfect for malware analysis (not 24/7 workload)

5. **Set spending alerts:**
   - Azure Portal ‚Üí Cost Management ‚Üí Budgets
   - Set alert at $20 and $40 per month

---

## üöÄ Quick Start Commands

### FIRST: Find Your Allowed Regions
```powershell
# Install Azure CLI (if not already installed)
winget install Microsoft.AzureCLI

# Login to Azure
az login

# Test which regions work for your subscription
# Try these common student-allowed regions:
Write-Host "Testing East US..." -ForegroundColor Yellow
az vm list-skus --location eastus --size Standard_B2s --output table --query "[0]"

Write-Host "Testing West US..." -ForegroundColor Yellow
az vm list-skus --location westus --size Standard_B2s --output table --query "[0]"

Write-Host "Testing Central US..." -ForegroundColor Yellow
az vm list-skus --location centralus --size Standard_B2s --output table --query "[0]"

Write-Host "Testing West Europe..." -ForegroundColor Yellow
az vm list-skus --location westeurope --size Standard_B2s --output table --query "[0]"

# If you see output (not an error), that region is allowed!
# Use that region for ALL resources below
```

### Azure CLI Setup (Run from your local machine):
```powershell
# Set subscription (Azure for Students)
az account set --subscription "Azure for Students"

# View VM status
az vm list --resource-group rg-malware-sandbox --output table

# Stop VM (deallocate to save costs)
az vm deallocate --resource-group rg-malware-sandbox --name vm-malware-lab-01

# Start VM
az vm start --resource-group rg-malware-sandbox --name vm-malware-lab-01

# Get VM public IP
az vm show --resource-group rg-malware-sandbox --name vm-malware-lab-01 --show-details --query publicIps --output tsv

# Delete entire sandbox when done
az group delete --name rg-malware-sandbox --yes --no-wait
```

---

## üìä Integration with Your Project

### Automated Sandbox ‚Üí Backend Integration

#### **Option 1: CAPE Sandbox API Integration**
If you deploy CAPE v2, integrate with your backend:

```python
# backend/cape_integration.py
import requests
import json
from typing import Dict, List

class CAPEClient:
    def __init__(self, cape_url: str = "http://10.0.1.10:8000"):
        """Connect to CAPE sandbox API (internal VNet only)"""
        self.base_url = cape_url
        self.api_url = f"{cape_url}/api"
    
    def submit_file(self, file_path: str, timeout: int = 300) -> int:
        """Submit malware sample to CAPE for analysis"""
        with open(file_path, "rb") as f:
            files = {"file": f}
            response = requests.post(
                f"{self.api_url}/tasks/create/file/",
                files=files,
                data={"timeout": timeout}
            )
        return response.json()["task_id"]
    
    def get_report(self, task_id: int) -> Dict:
        """Retrieve behavioral analysis report"""
        response = requests.get(f"{self.api_url}/tasks/report/{task_id}/json")
        return response.json()
    
    def extract_behaviors(self, report: Dict) -> List[Dict]:
        """Extract ransomware-relevant behaviors from CAPE report"""
        behaviors = []
        
        # File modifications
        if "behavior" in report and "summary" in report["behavior"]:
            summary = report["behavior"]["summary"]
            
            # Mass file encryption indicators
            if "file_written" in summary:
                behaviors.append({
                    "type": "mass_file_write",
                    "count": len(summary["file_written"]),
                    "extensions": self._get_file_extensions(summary["file_written"])
                })
            
            # Registry modifications (ransom notes, persistence)
            if "regkey_written" in summary:
                behaviors.append({
                    "type": "registry_modification",
                    "keys": summary["regkey_written"]
                })
            
            # Volume Shadow Copy deletion
            if "command_line" in summary:
                for cmd in summary["command_line"]:
                    if "vssadmin delete shadows" in cmd.lower():
                        behaviors.append({
                            "type": "shadow_copy_deletion",
                            "command": cmd,
                            "severity": "CRITICAL"
                        })
        
        # Network indicators (C2 communication)
        if "network" in report:
            for connection in report["network"].get("tcp", []):
                behaviors.append({
                    "type": "network_connection",
                    "dst": connection["dst"],
                    "port": connection["dport"]
                })
        
        return behaviors
    
    def _get_file_extensions(self, files: List[str]) -> List[str]:
        """Extract unique file extensions from file paths"""
        extensions = set()
        for f in files:
            if "." in f:
                extensions.add(f.split(".")[-1])
        return list(extensions)


# Example: Integrate with your ransomware detection pipeline
def analyze_sample(sample_path: str):
    cape = CAPEClient()
    
    # Submit to CAPE
    task_id = cape.submit_file(sample_path, timeout=300)
    print(f"Submitted to CAPE: Task ID {task_id}")
    
    # Wait for analysis (poll every 30 seconds)
    import time
    while True:
        try:
            report = cape.get_report(task_id)
            if report["info"]["status"] == "completed":
                break
        except:
            pass
        time.sleep(30)
    
    # Extract behavioral features
    behaviors = cape.extract_behaviors(report)
    
    # Send to your backend ML model
    from backend.ml_model import predict_ransomware
    prediction = predict_ransomware(behaviors)
    
    return {
        "task_id": task_id,
        "behaviors": behaviors,
        "is_ransomware": prediction["is_ransomware"],
        "confidence": prediction["confidence"]
    }
```

#### **Option 2: FLARE-VM Custom Monitoring**
If using FLARE-VM, create custom monitoring scripts:

```python
# monitoring_agent.py - Run this inside FLARE-VM

import psutil
import json
import time
from pathlib import Path
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class RansomwareMonitor(FileSystemEventHandler):
    def __init__(self):
        self.file_events = []
        self.start_time = time.time()
    
    def on_modified(self, event):
        if not event.is_directory:
            self.file_events.append({
                "timestamp": time.time() - self.start_time,
                "event": "modified",
                "path": event.src_path
            })
    
    def on_created(self, event):
        if not event.is_directory:
            # Check for ransom note indicators
            if any(keyword in event.src_path.lower() for keyword in 
                   ["readme", "decrypt", "recover", "ransom", "help"]):
                self.file_events.append({
                    "timestamp": time.time() - self.start_time,
                    "event": "ransom_note_created",
                    "path": event.src_path,
                    "severity": "CRITICAL"
                })
            else:
                self.file_events.append({
                    "timestamp": time.time() - self.start_time,
                    "event": "created",
                    "path": event.src_path
                })
    
    def get_report(self):
        return {
            "file_events": self.file_events,
            "total_events": len(self.file_events),
            "duration": time.time() - self.start_time
        }

def monitor_malware_execution(malware_path: str, duration: int = 300):
    """Monitor malware for specified duration (seconds)"""
    
    # Start filesystem monitoring
    monitor = RansomwareMonitor()
    observer = Observer()
    observer.schedule(monitor, "C:\\Users\\labadmin\\Documents", recursive=True)
    observer.start()
    
    # Execute malware
    import subprocess
    proc = subprocess.Popen([malware_path])
    
    # Monitor for duration
    time.sleep(duration)
    
    # Terminate malware
    proc.terminate()
    observer.stop()
    observer.join()
    
    # Generate report
    report = monitor.get_report()
    
    # Save locally
    with open("C:\\analysis\\behavior_report.json", "w") as f:
        json.dump(report, f, indent=2)
    
    return report

# Usage
if __name__ == "__main__":
    report = monitor_malware_execution("C:\\samples\\sample.exe", duration=300)
    print(f"Analysis complete: {report['total_events']} events captured")
```

#### **Option 3: Hybrid Approach with API Sequence Tracking (Recommended)**

Combines FLARE-VM, Process Monitor, and API call sequencing for complete behavioral analysis.

**Full Workflow:**

1. **Setup FLARE-VM** with monitoring tools
2. **Capture API sequences** using one of these methods:
   - **Frida** (real-time API hooking) - Most powerful
   - **Process Monitor** (complete system activity log) - Easiest

3. **Parse and analyze** behavioral patterns
4. **Send to your backend** for ML-based detection

---

##### **Method A: Frida-based Real-Time API Tracing**

Intercepts Windows API calls in sequential order (most powerful):

```python
# vm_api_tracer.py - Real-time API call sequencing with Frida
# See: testing_code/activity_monitor/vm_api_tracer.py

# Installation in VM:
# pip install frida frida-tools

# Usage:
# python vm_api_tracer.py ransomware_simulator.py

# Output: api_trace.json with sequential API calls:
# [
#   {"timestamp": 0.001, "api": "CreateFileW", "args": {"path": "file.txt"}},
#   {"timestamp": 0.002, "api": "WriteFile", "args": {"bytes": 1024}},
#   {"timestamp": 0.003, "api": "MoveFileExW", "args": {"to": "file.encrypted"}},
#   ...
# ]
```

**Captured API calls:**
- File operations: `CreateFileW`, `WriteFile`, `DeleteFileW`, `MoveFileExW`
- Registry: `RegOpenKeyExW`, `RegSetValueExW`, `RegDeleteValueW`
- Network: `connect()`, `send()`, `WSAStartup()`
- Crypto: `CryptEncrypt`, `CryptDecrypt`, `CryptGenKey`
- Process: `CreateProcessW`, `CreateThread`, `TerminateProcess`

**Ransomware pattern detection:**
- Mass file writes (>50 files)
- File rename to `.encrypted/.locked/.crypto`
- Shadow copy deletion (`vssadmin delete shadows`)
- Registry persistence (`Run`, `RunOnce` keys)

---

##### **Method B: Process Monitor CSV Parsing**

Uses Sysinternals Process Monitor (already in FLARE-VM):

```python
# vm_procmon_api_parser.py - Parse Procmon logs for API sequences
# See: testing_code/activity_monitor/vm_procmon_api_parser.py

# Workflow:
# 1. Start Procmon.exe in VM
# 2. Add filter: Process Name contains "python"
# 3. Run malware: python ransomware_simulator.py
# 4. Stop Procmon, File ‚Üí Save ‚Üí CSV format
# 5. Parse: python vm_procmon_api_parser.py procmon_log.csv

# Output: api_analysis.json with:
{
  "patterns": {
    "file_writes": 500,
    "file_renames": 400,
    "registry_writes": 60,
    "shadow_copy_commands": 1
  },
  "features": {
    "suspicion_score": 85,
    "ransomware_probability": 0.95,
    "has_mass_file_operations": true,
    "has_crypto_usage": true
  },
  "api_sequence_sample": [...]  // First 100 operations in order
}
```

**Detected patterns:**
- File encryption sequences: `CreateFile` ‚Üí `WriteFile` ‚Üí `Rename` to `.encrypted`
- Registry persistence: Writes to `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- Network C2 communication: TCP connections to suspicious IPs
- Process trees: Child process creation chains

---

##### **Method C: Simple Behavioral Monitor**

Uses `psutil` and Windows registry (no external tools):

```python
# vm_behavioral_monitor.py - Existing monitor + API categorization
# See: testing_code/activity_monitor/vm_behavioral_monitor.py

# Usage:
# python vm_behavioral_monitor.py ransomware_simulator.py

# Captures:
# - File operations (before/after snapshots)
# - Registry changes (before/after comparison)
# - Network connections (active connections during execution)
# - Process tree (spawned child processes)
# - DLLs loaded
```

---

##### **Integration with Your Backend**

Send behavioral data + API sequences to your ML model:

```python
# backend/cape_integration.py (UPDATED)

import requests
import json

def analyze_with_api_sequence(behavioral_data: dict, api_sequence: list):
    """
    Combine behavioral data with API call sequences
    """
    # Extract sequential patterns
    api_categories = categorize_api_calls(api_sequence)
    
    # Merge with behavioral features
    features = {
        **behavioral_data,
        'api_sequence_length': len(api_sequence),
        'file_api_calls': api_categories['file'],
        'registry_api_calls': api_categories['registry'],
        'network_api_calls': api_categories['network'],
        'crypto_api_calls': api_categories['crypto'],
        
        # Sequential patterns (CRITICAL for ML)
        'has_encrypt_rename_pattern': detect_encrypt_rename(api_sequence),
        'shadow_copy_deletion_attempt': detect_shadow_copy_deletion(api_sequence),
        'registry_persistence_pattern': detect_persistence(api_sequence),
        'c2_beacon_pattern': detect_c2_beacon(api_sequence)
    }
    
    # Send to your backend
    response = requests.post(
        "https://your-backend.com/api/analyze",
        json=features,
        headers={"Authorization": "Bearer YOUR_API_KEY"}
    )
    
    return response.json()

def categorize_api_calls(api_sequence: list) -> dict:
    """Group API calls by category"""
    categories = {
        'file': [],
        'registry': [],
        'network': [],
        'crypto': [],
        'process': []
    }
    
    for call in api_sequence:
        api = call.get('api', '') or call.get('operation', '')
        
        if 'File' in api:
            categories['file'].append(call)
        elif 'Reg' in api:
            categories['registry'].append(call)
        elif any(x in api for x in ['TCP', 'UDP', 'connect', 'send']):
            categories['network'].append(call)
        elif 'Crypt' in api:
            categories['crypto'].append(call)
        elif 'Process' in api or 'Thread' in api:
            categories['process'].append(call)
    
    return categories

def detect_encrypt_rename(api_sequence: list) -> bool:
    """
    Detect ransomware encryption pattern:
    CreateFile ‚Üí WriteFile ‚Üí Rename to .encrypted
    """
    for i in range(len(api_sequence) - 2):
        if ('CreateFile' in str(api_sequence[i]) and
            'Write' in str(api_sequence[i+1]) and
            'Rename' in str(api_sequence[i+2])):
            # Check if renamed to suspicious extension
            if any(ext in str(api_sequence[i+2]).lower() 
                   for ext in ['.encrypted', '.locked', '.crypto']):
                return True
    return False

def detect_shadow_copy_deletion(api_sequence: list) -> bool:
    """Detect vssadmin delete shadows command"""
    for call in api_sequence:
        if 'CreateProcess' in str(call):
            args = call.get('args', {})
            cmd = args.get('command', '') or args.get('detail', '')
            if 'vssadmin' in cmd.lower() and 'delete' in cmd.lower():
                return True
    return False

def detect_persistence(api_sequence: list) -> bool:
    """Detect registry persistence mechanism"""
    for call in api_sequence:
        if 'RegSet' in str(call):
            path = call.get('path', '') or call.get('args', {}).get('path', '')
            if any(key in path.lower() for key in ['\\run', '\\runonce', '\\winlogon']):
                return True
    return False

def detect_c2_beacon(api_sequence: list) -> bool:
    """Detect repeated network connections (C2 beaconing)"""
    connections = [c for c in api_sequence if 'connect' in str(c).lower() or 'send' in str(c).lower()]
    # If more than 10 network calls in sequence, likely C2 beacon
    return len(connections) > 10
```

---

##### **Complete VM ‚Üí Backend Pipeline**

```bash
# 1. Inside Azure VM with FLARE-VM:

# Option A: Frida (real-time)
pip install frida frida-tools
python vm_api_tracer.py malware.exe
# Output: api_trace.json

# Option B: Process Monitor (comprehensive)
# Start Procmon.exe ‚Üí Run malware ‚Üí Export CSV
python vm_procmon_api_parser.py procmon_log.csv malware.exe
# Output: api_analysis.json

# 2. Transfer results to host (via Bastion file transfer or Azure Blob)

# 3. On host machine, send to your backend:
python host_analyze.py api_trace.json behavioral_data.json

# 4. Your backend ML model receives:
{
  "file_encryption_count": 500,
  "registry_writes": 60,
  "network_c2_attempts": 1000,
  "api_sequence_length": 15234,
  "has_encrypt_rename_pattern": true,
  "shadow_copy_deletion_attempt": true,
  "ransomware_probability": 0.98
}
```

### Connect to Your Backend:
Your VM can send behavioral data to your backend:

1. **Option A:** Azure Blob Storage (in different resource group)
   - VM uploads logs to blob
   - Your backend pulls from blob
   - No direct network connection needed

2. **Option B:** Loosen NSG temporarily
   - Add outbound rule allowing traffic to YOUR backend IP only
   - VM sends data via API
   - Re-enable full lockdown after

3. **Option C:** Export logs via Bastion
   - Download logs manually
   - Process on local machine
   - Upload results to your backend

### Automated Analysis Pipeline:
```python
# Example: VM setup script
# Run this INSIDE the VM after snapshot restore

import subprocess
import json
from pathlib import Path

# Start monitoring
procmon = subprocess.Popen(["Procmon.exe", "/AcceptEula", "/BackingFile", "C:\\logs\\procmon.pml"])

# Run malware
malware_path = "C:\\samples\\malware.exe"
malware_proc = subprocess.Popen([malware_path])

# Wait and monitor
import time
time.sleep(300)  # 5 minutes

# Stop monitoring
procmon.terminate()

# Export behavioral data
behaviors = extract_behaviors("C:\\logs\\procmon.pml")
with open("C:\\logs\\behaviors.json", "w") as f:
    json.dump(behaviors, f)

# Upload to blob storage (if configured)
# upload_to_blob("behaviors.json")
```

---

## ‚ö†Ô∏è Important Warnings

### DO NOT:
- ‚ùå Connect this VM to your Azure AD
- ‚ùå Access personal OneDrive, email, or cloud storage from this VM
- ‚ùå Use your personal Azure credentials inside the VM
- ‚ùå Install legitimate licensed software (use trial/free versions)
- ‚ùå Leave VM running overnight without auto-shutdown
- ‚ùå Connect VM to VPN or proxy services
- ‚ùå Analyze malware on your local machine "just to test"

### DO:
- ‚úÖ Always verify network isolation before running malware
- ‚úÖ Keep snapshots of clean states
- ‚úÖ Use separate credentials for everything
- ‚úÖ Monitor Azure costs daily during testing
- ‚úÖ Delete resources immediately when project is complete
- ‚úÖ Document every malware sample you analyze
- ‚úÖ Never share VM credentials or allow external access

---

## üéì Learning Resources

### Azure Documentation:
- [Azure Virtual Machines](https://learn.microsoft.com/en-us/azure/virtual-machines/)
- [Network Security Groups](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)
- [VM Snapshots](https://learn.microsoft.com/en-us/azure/virtual-machines/snapshot-copy-managed-disk)

### Malware Analysis Sandboxes:
- [FLARE-VM Setup](https://github.com/mandiant/flare-vm) - Mandiant's complete malware analysis environment
- [CAPE Sandbox](https://github.com/kevoreilly/CAPEv2) - Automated malware analysis with behavioral reports
- [Cuckoo Sandbox](https://cuckoosandbox.org/) - Original automated sandbox (CAPE is based on this)
- [REMnux](https://remnux.org/) - Linux distribution for reverse engineering (pairs well with FLARE-VM)

### Malware Analysis Tools Documentation:
- [Sysinternals Suite](https://learn.microsoft.com/en-us/sysinternals/) - Process Monitor, Process Explorer, etc.
- [Process Monitor Tutorial](https://www.varonis.com/blog/how-to-use-process-monitor) - Master ProcMon for malware analysis
- [x64dbg](https://x64dbg.com/) - Open-source debugger (included in FLARE-VM)
- [Ghidra](https://ghidra-sre.org/) - NSA's reverse engineering framework

### Ransomware-Specific Resources:
- [Ransomware Detection Behavioral Indicators](https://www.crowdstrike.com/cybersecurity-101/ransomware/)
- [MITRE ATT&CK - Ransomware](https://attack.mitre.org/techniques/T1486/) - Tactics and techniques
- [No More Ransom Project](https://www.nomoreransom.org/) - Decryption tools and info

### Integration & Automation:
- [CAPE API Documentation](https://capev2.readthedocs.io/en/latest/usage/api.html) - REST API for automated submissions
- [Python Malware Analysis Libraries](https://github.com/rshipp/awesome-malware-analysis#python-libraries)
- [Process Monitor to JSON Parser](https://github.com/eronnen/procmon-parser) - Parse ProcMon logs programmatically

---

## üìù Next Steps

### For Manual Analysis Setup:
1. **Today:** Create resource group, VNet, and NSG
2. **Today:** Create VM and verify you can access it
3. **Tomorrow:** Install monitoring tools and create baseline snapshot
4. **Tomorrow:** Test the snapshot restore process
5. **This Week:** Run first malware sample with full isolation verification
6. **Ongoing:** Integrate with your ransomware detection backend

### For FLARE-VM + API Sequencing (Recommended):
1. **Day 1:** Deploy Windows 10/11 VM (D2s_v3 minimum, 128GB SSD)
2. **Day 1:** Run FLARE-VM installer (takes 2-3 hours, let it run)
3. **Day 2:** Install Frida: `pip install frida frida-tools`
4. **Day 2:** Create `snap-flare-configured` snapshot
5. **Day 3:** Copy monitoring scripts to VM:
   - `testing_code/activity_monitor/vm_api_tracer.py` (Frida-based)
   - `testing_code/activity_monitor/vm_procmon_api_parser.py` (Procmon parser)
   - `testing_code/activity_monitor/vm_behavioral_monitor.py` (psutil-based)
6. **Day 3:** Test with your ransomware simulator
7. **Week 2:** Connect to your backend API for automated processing

### For CAPE Sandbox Setup (Advanced):
1. **Day 1:** Deploy Ubuntu 20.04/22.04 VM (D4s_v3 minimum, 250GB SSD)
2. **Day 1-2:** Install CAPE dependencies (follow official docs)
3. **Day 3:** Configure CAPE for Azure networking
4. **Day 4:** Deploy Windows guest VMs for analysis (nested virtualization)
5. **Week 2:** Integrate CAPE API with your backend
6. **Ongoing:** Monitor costs (~$120/month minimum)

### Quick Start Comparison:

| Metric | Manual Tools | FLARE-VM | CAPE v2 |
|--------|--------------|----------|---------|
| Setup Time | 1 hour | 4 hours | 2-3 days |
| Disk Space | 60GB | 128GB | 250GB+ |
| Monthly Cost | $15 | $40 | $120+ |
| Automation Level | Low | Medium | High |
| Learning Curve | Beginner | Intermediate | Advanced |
| **Recommended For** | **Learning** | **Student Projects** | **Production** |

---

## üÜò Troubleshooting

### "RequestDisallowedByAzure" or Region Policy Violation
**Error:** `Resource was disallowed by Azure: This policy maintains a set of best available regions...`

**CAUSE:** Your Azure for Students subscription has region restrictions.

**SOLUTION:**
1. Delete any failed deployments in the resource group
2. Find allowed regions:
   ```powershell
   # Test common regions
   az vm list-skus --location eastus --size Standard_B2s --output table
   az vm list-skus --location westus --size Standard_B2s --output table
   az vm list-skus --location centralus --size Standard_B2s --output table
   ```
3. Recreate resources in an allowed region (usually East US, West US, or Central US)
4. **Use the SAME region for ALL resources** (RG, VNet, NSG, VM, etc.)

### "VM and VNet Must Be in Same Region" Error
**Error:** VM shows "East Asia" available, VNet only allows "Southeast Asia" (or vice versa)

**CAUSE:** Azure for Students has inconsistent region availability for different resource types.

**SOLUTION:**
1. **Pick ONE region and force everything into it:**
   ```powershell
   # Test if Southeast Asia supports BOTH VMs and VNets
   az vm list-skus --location southeastasia --size Standard_B1s --output table
   az vm list-skus --location southeastasia --size Standard_B2ms --output table
   
   # If you see "NotAvailableForSubscription" restriction, try different size
   # B1s, B2ms, B4ms might work even if B2s doesn't
   ```

2. **Try alternative VM sizes in your allowed region:**
   - Instead of `Standard_B2s` ‚Üí try `Standard_B2s_v2`, `Standard_B2ms`, or `Standard_B1s`
   - Some sizes have different regional availability

3. **Create VNet in the SAME region as your working VM size:**
   - If `Standard_B1s` works in Southeast Asia ‚Üí create VNet in Southeast Asia
   - Don't create VNet first, create it AFTER confirming VM size availability

4. **Worst case - use a different Azure region entirely:**
   - Delete the resource group and try "East US" or "West Europe" for EVERYTHING
   - These regions usually have better Azure for Students support

### "Can't connect to VM"
- Check if VM is running (not stopped/deallocated)
- Verify NSG allows RDP from your IP (inbound rule)
- Check if Bastion is properly deployed

### "VM is expensive"
- Stop (deallocate) when not in use
- Consider switching to B1s or B2s
- Remove Bastion if not critical
- Set up auto-shutdown

### "Snapshot restore failed"
- Ensure VM is stopped before swapping disks
- Check snapshot is in same region as VM
- Verify you have owner/contributor permissions

### "Malware escaped the VM"
- VERIFY NSG rules immediately
- Check Azure Activity Log for any resource changes
- Delete entire resource group if concerned
- Contact Azure support if needed

---

**Remember:** The goal is to safely analyze malware behavior for your ransomware detection system, NOT to actually have your systems compromised. When in doubt, add more isolation layers!

Good luck with your project! üõ°Ô∏è
